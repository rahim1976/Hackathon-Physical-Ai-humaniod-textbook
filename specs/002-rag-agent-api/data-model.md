# Data Model: OpenAI Agent with Qdrant Integration

## Core Entities

### AgentThread
**Description**: Represents a single conversation thread with the OpenAI agent

**Fields**:
- `thread_id` (str): Unique identifier for the thread (required)
- `created_at` (datetime): Timestamp when thread was created (required)
- `status` (str): Current status (active, completed, error) (required)
- `messages` (List[Message]): List of messages in the conversation (optional)

**Relationships**:
- Contains multiple `Message` entities
- Associated with multiple `ToolCall` entities during its lifecycle

**Validation Rules**:
- `thread_id` must be a valid OpenAI thread ID format
- `created_at` must be in ISO 8601 format
- `status` must be one of: "active", "completed", "error"

### Message
**Description**: Represents a single message in a conversation thread

**Fields**:
- `message_id` (str): Unique identifier for the message (required)
- `role` (str): Role of the message sender (user, assistant, system) (required)
- `content` (str): The message content (required)
- `timestamp` (datetime): When the message was created (required)
- `thread_id` (str): Reference to parent thread (required)

**Relationships**:
- Belongs to one `AgentThread`
- May be associated with multiple `ToolCall` entities

**Validation Rules**:
- `role` must be one of: "user", "assistant", "system"
- `content` must not exceed 10000 characters
- `timestamp` must be in ISO 8601 format

### RetrievalResult
**Description**: Represents a single retrieved chunk from Qdrant

**Fields**:
- `id` (str): Unique identifier for the chunk in Qdrant (required)
- `content` (str): The retrieved text content (required)
- `url` (str): Source URL for the content (required)
- `position` (int): Position in the original document (optional, default: 0)
- `similarity_score` (float): Semantic similarity score (0.0-1.0) (required)
- `section` (str): Section name if available (optional)
- `heading` (str): Heading name if available (optional)
- `created_at` (datetime): When the chunk was indexed (optional)

**Relationships**:
- Generated by `QdrantRetrievalTool`
- Used as input to `AgentResponse`

**Validation Rules**:
- `similarity_score` must be between 0.0 and 1.0
- `content` must not be empty
- `url` must be a valid URL format if provided

### ToolCall
**Description**: Represents a function tool call made by the agent

**Fields**:
- `tool_call_id` (str): Unique identifier for the tool call (required)
- `function_name` (str): Name of the function called (required)
- `arguments` (Dict): Arguments passed to the function (required)
- `result` (str): Result of the function call (optional)
- `timestamp` (datetime): When the call was made (required)
- `thread_id` (str): Reference to the thread where call occurred (required)

**Relationships**:
- Belongs to one `AgentThread`
- Associated with one `Message`

**Validation Rules**:
- `function_name` must match registered tools
- `arguments` must conform to function schema
- `timestamp` must be in ISO 8601 format

### AgentResponse
**Description**: Represents the final response from the agent

**Fields**:
- `response_id` (str): Unique identifier for the response (required)
- `content` (str): The agent's response content (required)
- `sources` (List[str]): List of source URLs referenced (required)
- `chunks_used` (int): Number of retrieval results used (required)
- `relevant_chunks` (List[RetrievalResult]): The chunks that were referenced (optional)
- `status` (str): Response status (success, error, timeout) (required)
- `error` (str): Error message if status is error (optional)
- `timestamp` (datetime): When response was generated (required)

**Relationships**:
- Composed of multiple `RetrievalResult` entities
- Associated with one `AgentThread`

**Validation Rules**:
- `status` must be one of: "success", "error", "timeout"
- `chunks_used` must be >= 0
- `content` must not exceed 5000 characters

## State Transitions

### AgentThread State Transitions
```
CREATED → ACTIVE → COMPLETED
     ↓         ↓         ↓
   ERROR ←----------- TIMEOUT
```

- **CREATED**: Thread initialized, waiting for first message
- **ACTIVE**: Thread processing, agent may be making tool calls
- **COMPLETED**: Thread finished, response generated
- **ERROR**: Thread encountered an unrecoverable error
- **TIMEOUT**: Thread exceeded maximum processing time

### ToolCall State Transitions
```
PENDING → EXECUTING → COMPLETED
     ↓         ↓           ↓
   ERROR ←------------- TIMEOUT
```

- **PENDING**: Tool call queued, waiting for execution
- **EXECUTING**: Tool call in progress
- **COMPLETED**: Tool call finished successfully
- **ERROR**: Tool call failed with an error
- **TIMEOUT**: Tool call exceeded maximum execution time

## API Data Structures

### Request Models

#### AgentChatRequest
```json
{
  "query": "user question",
  "top_k": 5,
  "threshold": 0.5,
  "temperature": 0.7
}
```

**Validation**:
- `query` must be 1-1000 characters
- `top_k` must be 1-20
- `threshold` must be 0.0-1.0
- `temperature` must be 0.0-2.0

#### AgentChatResponse
```json
{
  "response": "agent response",
  "sources": ["url1", "url2"],
  "chunks_used": 3,
  "relevant_chunks": [RetrievalResult...],
  "status": "success",
  "request_id": "unique_request_id"
}
```

**Validation**:
- `status` must be one of: "success", "error"
- `chunks_used` must match length of `relevant_chunks` if provided
- `request_id` must be a valid UUID format

## Database Schema Considerations

### Indexing Strategy
- `AgentThread.created_at`: For time-based queries
- `RetrievalResult.similarity_score`: For relevance-based queries
- `RetrievalResult.url`: For source-based queries
- `ToolCall.function_name`: For performance analysis

### Performance Considerations
- Store frequently accessed fields in memory when possible
- Implement caching for common retrieval results
- Use pagination for large result sets
- Implement proper connection pooling for Qdrant

## Security Considerations

### Data Validation
- Sanitize all user inputs before processing
- Validate URLs and other external references
- Implement size limits on content fields
- Use parameterized queries where applicable

### Privacy Protection
- Do not store sensitive user information unnecessarily
- Implement proper access controls for thread data
- Encrypt sensitive data at rest
- Log only non-sensitive information for debugging